# 冰箱溫度控制器 IC 架構設計

## 1. 系統概覽

### 1.1 架構總覽
本設計採用模組化架構，將系統分為數位控制核心、介面模組、和輔助功能模組三大部分。

```
┌─────────────────────────────────────────────────────────────────┐
│                    Temperature Controller IC                      │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │   Top Module    │  │  ADC SPI     │  │   Temperature    │  │
│  │  temp_ctrl_top  │←→│  Interface   │←→│     Sensor       │  │
│  └────────┬────────┘  └──────────────┘  └──────────────────┘  │
│           │                                                      │
│  ┌────────▼────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │  PID Controller │  │  PWM         │  │   Compressor     │  │
│  │  pid_controller │→ │  Generator   │→ │     Motor        │  │
│  └─────────────────┘  └──────────────┘  └──────────────────┘  │
│                                                                  │
│  ┌─────────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │  State Machine  │  │  Display     │  │   7-Segment      │  │
│  │  ctrl_fsm       │→ │  Controller  │→ │     Display      │  │
│  └─────────────────┘  └──────────────┘  └──────────────────┘  │
│                                                                  │
│  ┌─────────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │  Timer Module   │  │  Defrost     │  │   User           │  │
│  │  timer_ctrl     │→ │  Controller  │  │   Interface      │  │
│  └─────────────────┘  └──────────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 設計原則
- **同步設計**：所有時序邏輯使用單一時脈域 (10 MHz)
- **模組化**：每個功能獨立封裝，介面標準化
- **可測試性**：內建測試模式和除錯介面
- **低功耗**：實施時脈閘控和電源管理

## 2. 模組設計

### 2.1 頂層模組 (temp_ctrl_top)

#### 功能描述
整合所有子模組，處理系統級控制和資料路由。

#### 介面定義
```verilog
module temp_ctrl_top (
    // 系統信號
    input  wire        clk,           // 10 MHz 系統時脈
    input  wire        rst_n,         // 低電平有效重置
    
    // ADC 介面
    input  wire        adc_miso,      // ADC 資料輸入
    output wire        adc_mosi,      // ADC 資料輸出
    output wire        adc_sclk,      // ADC 時脈
    output wire        adc_cs_n,      // ADC 晶片選擇
    
    // 控制輸出
    output wire        compressor_pwm, // 壓縮機 PWM
    output wire        defrost_heater, // 除霜加熱器
    output wire        alarm,          // 警報輸出
    
    // 顯示介面
    output wire [6:0]  seven_seg,     // 七段顯示器
    output wire [3:0]  digit_sel,     // 數位選擇
    output wire [2:0]  status_led,    // 狀態 LED
    
    // 使用者介面
    input  wire        door_sensor,    // 門感測器
    input  wire        button_up,      // 上調按鈕
    input  wire        button_down,    // 下調按鈕
    input  wire        button_mode     // 模式按鈕
);
```

#### 內部架構
```
┌─────────────────────────────────────────────────────┐
│                    temp_ctrl_top                     │
├─────────────────────────────────────────────────────┤
│  ┌──────────────┐    ┌──────────────┐              │
│  │  Clock/Reset │    │   Register   │              │
│  │  Management  │    │     Bank     │              │
│  └──────┬───────┘    └──────┬───────┘              │
│         │                    │                       │
│  ┌──────▼───────────────────▼──────┐               │
│  │        System Bus (APB-like)      │               │
│  └──┬────────┬────────┬────────┬───┘               │
│     │        │        │        │                    │
│  ┌──▼──┐ ┌──▼──┐ ┌──▼──┐ ┌──▼──┐                │
│  │ ADC │ │ PID │ │ PWM │ │ FSM │                 │
│  └─────┘ └─────┘ └─────┘ └─────┘                 │
└─────────────────────────────────────────────────────┘
```

### 2.2 ADC SPI 介面模組 (adc_spi_interface)

#### 功能描述
實現與 12-bit ADC (ADC128S022 相容) 的 SPI 通訊協定。

#### 主要特性
- SPI Mode 0 (CPOL=0, CPHA=0)
- 時脈頻率：1 MHz (可配置)
- 16-bit 傳輸框架
- 自動通道選擇和轉換

#### 狀態機設計
```
         ┌─────┐
         │ IDLE├─────────┐
         └──┬──┘         │
            │ start      │
         ┌──▼──┐         │
         │ CS  │         │
         │ LOW │         │
         └──┬──┘         │
            │            │
         ┌──▼──┐         │
         │ XFER│         │ done
         │ DATA│         │
         └──┬──┘         │
            │            │
         ┌──▼──┐         │
         │ CS  │         │
         │ HIGH├─────────┘
         └─────┘
```

#### 時序圖
```
       ___     ___     ___     ___
SCLK     |___|   |___|   |___|   |___

CS_N  ‾‾‾‾‾\_________________/‾‾‾‾‾‾‾

MOSI  ----< A2 A1 A0 X X X X >--------

MISO  --------< D11-D0 >--------------
```

### 2.3 PID 控制器模組 (pid_controller)

#### 功能描述
實現數位 PID 控制演算法，使用 16-bit 定點運算。

#### 數學模型
```
u(t) = Kp×e(t) + Ki×∫e(t)dt + Kd×de(t)/dt

離散化形式：
u[n] = Kp×e[n] + Ki×Ts×Σe[k] + Kd×(e[n]-e[n-1])/Ts
```

#### 架構設計
```
┌────────────────────────────────────────┐
│            pid_controller               │
├────────────────────────────────────────┤
│  ┌──────────┐    ┌──────────┐         │
│  │  Error   │    │    P     │         │
│  │  Calc    ├───►│   Term   ├──┐      │
│  └──────────┘    └──────────┘  │      │
│                                 │      │
│  ┌──────────┐    ┌──────────┐  │      │
│  │ Integral │    │    I     │  ├──┐   │
│  │ Accumul. ├───►│   Term   ├──┘  │   │
│  └──────────┘    └──────────┘     │   │
│                                    │   │
│  ┌──────────┐    ┌──────────┐     │   │
│  │ Deriv.   │    │    D     │     ▼   │
│  │  Calc    ├───►│   Term   ├───►(Σ)──┤►
│  └──────────┘    └──────────┘         │
└────────────────────────────────────────┘
```

#### 定點格式
- 輸入/輸出：Q8.8 格式 (8位整數，8位小數)
- 內部運算：Q16.16 格式
- 係數範圍：Kp(0-16), Ki(0-1), Kd(0-1)

### 2.4 PWM 產生器模組 (pwm_generator)

#### 功能描述
產生可變佔空比的 PWM 信號控制壓縮機速度。

#### 規格參數
- PWM 頻率：1 kHz
- 解析度：10-bit (1024 級)
- 佔空比：0% - 100%
- 軟啟動/停止功能

#### 實現架構
```verilog
always @(posedge clk or negedge rst_n) begin
    if (!rst_n) begin
        counter <= 10'd0;
        pwm_out <= 1'b0;
    end else begin
        counter <= counter + 1'b1;
        pwm_out <= (counter < duty_cycle) ? 1'b1 : 1'b0;
    end
end
```

### 2.5 狀態機模組 (ctrl_fsm)

#### 功能描述
管理系統運行狀態和模式切換。

#### 狀態定義
```
typedef enum logic [2:0] {
    STATE_INIT     = 3'b000,  // 初始化
    STATE_NORMAL   = 3'b001,  // 正常運行
    STATE_DEFROST  = 3'b010,  // 除霜模式
    STATE_DOOR_OPEN= 3'b011,  // 門開啟
    STATE_ALARM    = 3'b100,  // 警報狀態
    STATE_TEST     = 3'b101   // 測試模式
} state_t;
```

#### 狀態轉換圖
```
        ┌─────────┐
        │  INIT   │
        └────┬────┘
             │ init_done
        ┌────▼────┐
    ┌───┤ NORMAL  ├───┐
    │   └────┬────┘   │
    │        │        │ door_open
    │ defrost│        ▼
┌───▼────┐  │   ┌─────────┐
│DEFROST │  │   │DOOR_OPEN│
└───┬────┘  │   └────┬────┘
    │       │        │ door_close
    └───────┴────────┘
           │
           │ alarm_trigger
      ┌────▼────┐
      │  ALARM  │
      └─────────┘
```

### 2.6 顯示控制器模組 (display_controller)

#### 功能描述
驅動 4 位數七段顯示器，支援多工掃描。

#### 顯示格式
- 正常模式：XX.X°C (如 -5.2°C)
- 設定模式：閃爍顯示設定值
- 錯誤模式：顯示錯誤代碼 (E01, E02...)

#### 掃描時序
- 掃描頻率：100 Hz (避免閃爍)
- 每位顯示時間：2.5 ms
- 亮度控制：PWM 調光

### 2.7 計時器模組 (timer_ctrl)

#### 功能描述
提供系統所需的各種定時功能。

#### 計時器配置
| 計時器 | 用途 | 週期 |
|--------|------|------|
| Timer0 | 控制迴路更新 | 1 秒 |
| Timer1 | 除霜週期 | 8 小時 |
| Timer2 | 壓縮機保護 | 3 分鐘 |
| Timer3 | 門開警報 | 2 分鐘 |

## 3. 介面協定

### 3.1 內部匯流排
採用簡化的 APB-like 協定：
- 32-bit 位址/資料匯流排
- 單一主控 (頂層模組)
- 無等待狀態

### 3.2 暫存器映射

| 位址 | 暫存器名稱 | 讀寫 | 描述 |
|------|------------|------|------|
| 0x00 | CTRL_REG | RW | 控制暫存器 |
| 0x04 | STATUS_REG | RO | 狀態暫存器 |
| 0x08 | TEMP_CURRENT | RO | 當前溫度 |
| 0x0C | TEMP_SET | RW | 設定溫度 |
| 0x10 | PID_KP | RW | PID Kp 係數 |
| 0x14 | PID_KI | RW | PID Ki 係數 |
| 0x18 | PID_KD | RW | PID Kd 係數 |
| 0x1C | PWM_DUTY | RO | PWM 佔空比 |
| 0x20 | ALARM_STATUS | RO | 警報狀態 |
| 0x24 | TIMER_CONFIG | RW | 計時器設定 |

## 4. 時脈與重置

### 4.1 時脈架構
```
             ┌──────────┐
    clk_in ──┤  Clock   │
    (10MHz)  │ Manager  │
             └────┬─────┘
                  │
        ┌─────────┼─────────┬──────────┐
        │         │         │          │
    ┌───▼──┐  ┌──▼──┐  ┌──▼──┐   ┌──▼──┐
    │ Core │  │ SPI │  │ PWM │   │Disp.│
    │10MHz │  │1MHz │  │10MHz│   │10kHz│
    └──────┘  └─────┘  └─────┘   └─────┘
```

### 4.2 重置策略
- 非同步重置，同步釋放
- 重置延遲：至少 10 個時脈週期
- 所有暫存器重置為已知狀態

## 5. 功耗管理

### 5.1 低功耗技術
1. **時脈閘控**：未使用模組關閉時脈
2. **運算閘控**：條件性執行邏輯
3. **暫存器隔離**：減少切換功耗

### 5.2 功耗模式
| 模式 | 描述 | 功耗 |
|------|------|------|
| 正常 | 全功能運行 | 5 mW |
| 待機 | 僅更新顯示 | 1 mW |
| 睡眠 | 保持設定值 | 100 μW |

## 6. 驗證策略

### 6.1 功能驗證
- 模組級測試平台
- 系統級整合測試
- 角落案例覆蓋

### 6.2 時序驗證
- 靜態時序分析 (STA)
- 後佈局模擬
- 時序約束驗證

### 6.3 功耗驗證
- 動態功耗分析
- 靜態功耗估算
- IR Drop 分析

## 7. 實體設計考量

### 7.1 Floorplan 策略
```
┌─────────────────────────────────┐
│          I/O Ring               │
├─────────────────────────────────┤
│ ┌─────┐  ┌─────────┐  ┌─────┐ │
│ │ ADC │  │  Core   │  │ PWM │ │
│ │ I/F │  │  Logic  │  │ Gen │ │
│ └─────┘  └─────────┘  └─────┘ │
│                                 │
│ ┌─────────────────────────────┐ │
│ │      Memory (Registers)     │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

### 7.2 時脈樹設計
- H-tree 結構
- 最大偏斜：< 100 ps
- 緩衝器插入優化

### 7.3 電源網格
- 雙層電源環
- 去耦電容策略
- 電源/地線寬度：20 μm

## 8. DFT (Design for Test)

### 8.1 掃描鏈設計
- 全掃描設計
- 3 條掃描鏈
- ATPG 覆蓋率 > 95%

### 8.2 BIST 功能
- 記憶體 BIST
- PLL BIST
- ADC 迴路測試

### 8.3 除錯介面
- JTAG 相容
- 內部信號觀察點
- 效能計數器

## 9. 設計檢查清單

### 9.1 RTL 設計
- [ ] 所有模組完成編碼
- [ ] Lint 檢查通過
- [ ] 程式碼審查完成
- [ ] 文件更新

### 9.2 驗證
- [ ] 模組測試完成
- [ ] 整合測試通過
- [ ] 覆蓋率 > 95%
- [ ] 時序收斂

### 9.3 實體設計
- [ ] DRC 無違規
- [ ] LVS 檢查通過
- [ ] 天線效應檢查
- [ ] 功耗符合規格

## 10. 風險與緩解

### 10.1 技術風險
| 風險 | 影響 | 緩解措施 |
|------|------|----------|
| 時序無法收斂 | 高 | 管線化設計、降頻 |
| 功耗超標 | 中 | 增強時脈閘控 |
| 面積超標 | 中 | 優化邏輯、共享資源 |

### 10.2 專案風險
- 驗證時間不足：採用形式驗證加速
- 工具相容性：預先測試流程
- 團隊經驗：安排培訓

---

文件版本: 1.0  
最後更新: 2024-12-19  
下一步: RTL 實作